

<!doctype html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text_Dataset &#8212; ml-indie-tools 0.11.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=532c1bf3" />
    
    <script src="../_static/documentation_options.js?v=f3b36f1a"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ml-indie-tools 0.11.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Text_Dataset</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Text_Dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Text_Dataset">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset">[docs]</a>
<span class="k">class</span> <span class="nc">Text_Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Text_Dataset with a list of texts.</span>

<span class="sd">    The Gutenberg_Dataset can be used to create such a list, by:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from ml_indie_tools.Gutenberg_Dataset import Gutenberg_Dataset</span>
<span class="sd">        from ml_indie_tools.Text_Dataset import Text_Dataset</span>
<span class="sd">        gd = Gutenberg_Dataset()</span>
<span class="sd">        gd.load_index()</span>
<span class="sd">        ls = gd.search({&#39;author&#39;: &#39;kant&#39;, &#39;title&#39;: &#39;kritik&#39;, &#39;language&#39;: &#39;german&#39;})  # returns a list of texts</span>
<span class="sd">        ls = gd.insert_texts(ls)  # this inserts the actual text of the books into field &#39;text&#39;.</span>
<span class="sd">        # Now ls contains a valid list of text records:</span>
<span class="sd">        td = Text_Dataset(ls)</span>

<span class="sd">    If text_list at initialization is None, texts can be added later with the load_texts() method.</span>

<span class="sd">    :param text_list: optional list of text-records of the form: {&#39;author&#39;: &#39;author&#39;, &#39;title&#39;: &#39;title&#39;, &#39;language&#39;: &#39;some-language&#39;,</span>
<span class="sd">    &#39;text&#39;: &#39;the-long-text&#39;}. Optional parameters: &#39;weight&#39;: 1.0</span>
<span class="sd">    :param sanitize_white_space: If True, white space is replaced by a single space.</span>
<span class="sd">    :param separate_punctuation: If True, punctuation is separated from words.</span>
<span class="sd">    :param preserve_case: If True, the case of the text is preserved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sanitize_white_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">separate_punctuation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Datasets&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_file_version</span> <span class="o">=</span> <span class="s2">&quot;0.9.2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_tokenizer_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngram_tokenizer_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytegram_tokenizer_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sos&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;eos&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;wsep&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;subst&gt;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">text_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_texts</span><span class="p">(</span>
                <span class="n">text_list</span><span class="p">,</span>
                <span class="n">sanitize_white_space</span><span class="o">=</span><span class="n">sanitize_white_space</span><span class="p">,</span>
                <span class="n">separate_punctuation</span><span class="o">=</span><span class="n">separate_punctuation</span><span class="p">,</span>
                <span class="n">preserve_case</span><span class="o">=</span><span class="n">preserve_case</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Text_Dataset.load_texts">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.load_texts">[docs]</a>
    <span class="k">def</span> <span class="nf">load_texts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_list</span><span class="p">,</span>
        <span class="n">sanitize_white_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">separate_punctuation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a list of texts into the Text_Dataset.</span>

<span class="sd">        Note: if there are already texts in the Text_Dataset, the new texts are appended.</span>

<span class="sd">        :param text_list: list of text-records of the form: {&#39;author&#39;: &#39;author&#39;, &#39;title&#39;: &#39;title&#39;, &#39;language&#39;: &#39;some-language&#39;,</span>
<span class="sd">        &#39;text&#39;: &#39;the-long-text&#39;}. Optional parameters: &#39;weight&#39;: 1.0</span>
<span class="sd">        :param sanitize_white_space: If True, white space is replaced by a single space.</span>
<span class="sd">        :param separate_punctuation: If True, punctuation is separated from words.</span>
<span class="sd">        :param preserve_case: If True, the case of the text is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_list</span><span class="p">)):</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">miss</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">req_attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_list</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">miss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">valid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing attribute(s) </span><span class="si">{</span><span class="n">miss</span><span class="si">}</span><span class="s2"> in text[</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">], skipping this text.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text_list</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">text</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
            <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_text</span><span class="p">(</span>
                <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                <span class="n">sanitize_white_space</span><span class="o">=</span><span class="n">sanitize_white_space</span><span class="p">,</span>
                <span class="n">separate_punctuation</span><span class="o">=</span><span class="n">separate_punctuation</span><span class="p">,</span>
                <span class="n">preserve_case</span><span class="o">=</span><span class="n">preserve_case</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2"> text&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">lt</span><span class="si">}</span><span class="s2"> texts&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_probability_weights</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_calc_probability_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">prs</span> <span class="o">=</span> <span class="n">prs</span> <span class="o">+</span> <span class="n">pr</span>
            <span class="n">text</span><span class="p">[</span><span class="s2">&quot;probability_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
            <span class="n">text</span><span class="p">[</span><span class="s2">&quot;probability_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;probability_weight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">prs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;probability_weight&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tc</span><span class="p">)</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_random_text_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a random text index from the Text_Dataset.</span>

<span class="sd">        :param weighted: If True, the probability of a text is weighted by its calculated &#39;probability_weight&#39; attribute.</span>
<span class="sd">        :return: a random text index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weighted</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tidx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcum</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tidx</span><span class="p">)</span>

<div class="viewcode-block" id="Text_Dataset.filter_text">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.filter_text">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">sanitize_white_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">separate_punctuation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter a text.</span>

<span class="sd">        :param text: text to filter</span>
<span class="sd">        :param sanitize_white_space: If True, white space is replaced by a single space.</span>
<span class="sd">        :param separate_punctuation: If True, punctuation is separated from words.</span>
<span class="sd">        :param preserve_case: If True, the case of the text is preserved.</span>
<span class="sd">        :return: filtered text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">preserve_case</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">punctuation</span> <span class="o">=</span> <span class="s2">&quot;!</span><span class="se">\&quot;</span><span class="s2">#$%&amp;&#39;()*+,-./:;&lt;=&gt;?@[</span><span class="se">\\</span><span class="s2">]^_`{|}~&quot;</span>
        <span class="k">if</span> <span class="n">separate_punctuation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">punctuation</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sanitize_white_space</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\v</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">to</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="n">to</span> <span class="o">!=</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">to</span> <span class="o">=</span> <span class="n">text</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>


    <span class="k">def</span> <span class="nf">_word_splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">word_separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">word_separator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">_every_ngram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">add_special_words</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all ngrams of length 1..max_len from text.</span>

<span class="sd">        :param text: text to extract ngrams from</span>
<span class="sd">        :param max_len: maximum length of ngrams to extract</span>
<span class="sd">        :param add_special_words: If True, special words (&#39;&lt;unk&gt;&#39; etc.) are added to the ngrams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngrams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">add_special_words</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ngrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span> <span class="o">+</span> <span class="n">ngrams</span>
        <span class="k">return</span> <span class="n">ngrams</span>

    <span class="k">def</span> <span class="nf">_is_valid_utf8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytetext</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_every_bytegram</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">bytetext</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">add_special_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_valid</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all ngrams of length 1..max_len from text.</span>

<span class="sd">        :param text: text to extract ngrams from</span>
<span class="sd">        :param max_len: maximum length of ngrams to extract</span>
<span class="sd">        :param add_special_words: If True, special words (&#39;&lt;unk&gt;&#39; etc.) are added to the ngrams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_valid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ngrams</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">bytetext</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_utf8</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bytetext</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ngrams</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">bytetext</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span>
                <span class="c1"># Only tuples of length 2..max_len are used, since length 1 is already covered by the raw-byte tokens 0..255</span>
                <span class="c1"># for j in range(1, min(len(bytetext) - i, max_len))</span>
            <span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">ngrams</span><span class="p">:</span>
                <span class="n">ngrams</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">i</span><span class="p">,))</span>
                <span class="c1"># print(f&quot;Removed {i}&quot;)</span>

        <span class="k">if</span> <span class="n">add_special_words</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sng</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">]</span>
            <span class="n">ngrams</span> <span class="o">=</span> <span class="n">sng</span> <span class="o">+</span> <span class="n">ngrams</span>

        <span class="k">return</span> <span class="n">ngrams</span>

    <span class="k">def</span> <span class="nf">_weight_ngrams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eg_dict</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">max_weight</span><span class="o">=</span><span class="mf">1e12</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weight ngrams by their length and frequency. Ngrams of length==1 and special words (&#39;&lt;unk&gt;&#39; etc.) are</span>
<span class="sd">        weigted by max_weight, since we need the full character set and the special words to be</span>
<span class="sd">        included in the ngram collection.</span>

<span class="sd">        :param eg_dict: Counter of ngrams to weight</span>
<span class="sd">        :param max_weight: maximum weight of ngrams, used to marked &#39;preferred&#39; ngrams: ngrams of length==1 and special words (&#39;&lt;unk&gt;&#39; etc.)</span>
<span class="sd">        :return: ngrams with weights in reverse sorted order (highest weight first)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lk</span><span class="p">),</span>
                    <span class="p">(</span>
                        <span class="n">max_weight</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">lk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span>
                        <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span> <span class="o">*</span> <span class="n">eg_dict</span><span class="p">[</span><span class="n">lk</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">eg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">],</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_weight_bytegrams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eg_dict</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">max_weight</span><span class="o">=</span><span class="mf">1e12</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weight ngrams by their length and frequency. Ngrams of length==1 and special words (&#39;&lt;unk&gt;&#39; etc.) are</span>
<span class="sd">        weigted by max_weight, since we need the full character set and the special words to be</span>
<span class="sd">        included in the ngram collection.</span>

<span class="sd">        :param eg_dict: Counter of bytegrams to weight</span>
<span class="sd">        :param max_weight: maximum weight of ngrams, used to marked &#39;preferred&#39; ngrams: ngrams of length==1 and special words (&#39;&lt;unk&gt;&#39; etc.)</span>
<span class="sd">        :return: ngrams with weights in reverse sorted order (highest weight first)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sng</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">lk</span><span class="p">,</span>
                    <span class="c1"># max_weight if len(lk) == 1 or lk in sng else len(lk) * eg_dict[lk],</span>
                    <span class="n">max_weight</span> <span class="k">if</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">sng</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span> <span class="o">*</span> <span class="n">eg_dict</span><span class="p">[</span><span class="n">lk</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">eg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">],</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Text_Dataset.init_tokenizer">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.init_tokenizer">[docs]</a>
    <span class="k">def</span> <span class="nf">init_tokenizer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;ngram&quot;</span><span class="p">,</span>
        <span class="n">max_ngrams</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">word_separator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the tokenizer with the text_list.</span>

<span class="sd">        The character tokenizer simply splits any language text into glyphs.</span>

<span class="sd">        A word tokenizer works for languages that have the concept of word separators (as in English,</span>
<span class="sd">        &#39; &#39; space). Word tokenizers are English-centric algorithms, since many other languages either</span>
<span class="sd">        can compose words into larger words with no separators, words being more similar to English</span>
<span class="sd">        syllables in that case, or have no word separators at all (as in Chinese), or have syllable</span>
<span class="sd">        separators (as in Tibetan, which has also a second kind of separators for sentence-fragments). For multi-language applications, use ngram tokenizers or character</span>
<span class="sd">        tokenizers.</span>

<span class="sd">        The ngram tokenizer can either first split text into words using a word_speparator</span>
<span class="sd">        and then extracting all possible ngrams, or it can extract all possible ngrams directly</span>
<span class="sd">        without any word-splitting, which is the default behavior with word_separator=None since it</span>
<span class="sd">        works for all languages classes.</span>

<span class="sd">        For ngrams, the tokenizer can extract ngrams of length 1..max_ngrams, and selects the top most</span>
<span class="sd">        used ngrams with upper limit max_tokens. The optimum for max_ngrams is usually around 3-6, and</span>
<span class="sd">        max_tokens should be significantly higher than the number of unique glyphs in the text_list.</span>
<span class="sd">        Using word_separator=None is usually significantly better than using a word_separator for ngrams.</span>

<span class="sd">        :param tokenizer: &#39;word&#39;, &#39;char&#39;, &#39;bytegram&#39;, or &#39;ngram&#39; (default)</span>
<span class="sd">        :param max_ngrams: (bytegram, ngram only) maximum n-gram length</span>
<span class="sd">        :param word_separator: (word, ngram) [deprecated!] character used to separate words, default None, which amounts to &#39; &#39; (space) for word and no word-splitting for ngram.</span>
<span class="sd">        :param max_tokens: (bytegram, ngram only) maximum number of tokens to use</span>
<span class="sd">        :param chunk_size: (bytegram, ngram only) if not None: if input texts are larger than chunk_size, they are split in chunk_size parts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting tokenizer on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> texts...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokenizer</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="s2">&quot;word&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">tok</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">tok</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_word_splitter</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">word_separator</span><span class="o">=</span><span class="n">word_separator</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">tokenizer</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="s2">&quot;char&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Unicode SUBSTITUTE for &#39;unknown&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Unicode SPACE for &#39;pad&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Unicode END OF TEXT for &#39;eos&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Unicode START OF TEXT for &#39;sos&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
                <span class="n">unique_chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unique_chars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">:</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_tokenizer_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">tokenizer</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="s2">&quot;ngram&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span> <span class="o">=</span> <span class="n">word_separator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span> <span class="o">=</span> <span class="n">max_ngrams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Extracting ngrams of length 1..</span><span class="si">{</span><span class="n">max_ngrams</span><span class="si">}</span><span class="s2"> from text_list, selecting </span><span class="si">{</span><span class="n">max_tokens</span><span class="si">}</span><span class="s2"> most used ngrams.&quot;</span>
            <span class="p">)</span>
            <span class="n">corpus</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                <span class="n">corpus</span> <span class="o">+=</span> <span class="n">text</span><span class="p">[</span>
                    <span class="s2">&quot;text&quot;</span>
                <span class="p">]</span>  <span class="c1"># TODO: This generates ngrams across text-borders, should be changed at some point.</span>
            <span class="k">if</span> <span class="n">word_separator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">word_list</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">word_separator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">word_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">eg_dict</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                    <span class="n">textbody</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">textbody</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
                            <span class="n">ngrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_every_ngram</span><span class="p">(</span>
                                <span class="n">textbody</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">],</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_ngrams</span>
                            <span class="p">)</span>
                            <span class="n">eg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ngrams</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ngrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_every_ngram</span><span class="p">(</span><span class="n">textbody</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_ngrams</span><span class="p">)</span>
                        <span class="n">eg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ngrams</span><span class="p">)</span>
                <span class="n">ngrams_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weight_ngrams</span><span class="p">(</span><span class="n">eg_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ngrams</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_list</span><span class="p">:</span>
                    <span class="n">ngrams</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_every_ngram</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_ngrams</span><span class="p">)</span>
                <span class="n">eg_dict</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ngrams</span><span class="p">)</span>
                <span class="n">ngrams_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weight_ngrams</span><span class="p">(</span><span class="n">eg_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ngrams_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_tokens</span><span class="p">:</span>
                    <span class="n">ngrams_list</span> <span class="o">=</span> <span class="n">ngrams_list</span><span class="p">[:</span><span class="n">max_tokens</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ngrams_list</span><span class="p">)}</span>
            <span class="k">del</span> <span class="n">ngrams_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngram_tokenizer_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">tokenizer</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="s2">&quot;bytegram&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span> <span class="o">=</span> <span class="n">max_ngrams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Extracting bytegrams of length 1..</span><span class="si">{</span><span class="n">max_ngrams</span><span class="si">}</span><span class="s2"> from text_list, selecting </span><span class="si">{</span><span class="n">max_tokens</span><span class="si">}</span><span class="s2"> (- 256 for single bytes) most used ngrams.&quot;</span>
            <span class="p">)</span>
            <span class="n">corpus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                <span class="n">corpus</span> <span class="o">+=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Corpus from byte texts created.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">eg_dict</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
                <span class="n">bytetext</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
                        <span class="n">bytegrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_every_bytegram</span><span class="p">(</span>
                            <span class="n">bytetext</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">],</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_ngrams</span>
                        <span class="p">)</span>
                        <span class="n">eg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bytegrams</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">chunk_size</span><span class="p">:</span>  <span class="c1"># less verbose</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Chunking: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bytegrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_every_bytegram</span><span class="p">(</span><span class="n">bytetext</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_ngrams</span><span class="p">)</span>
                    <span class="n">eg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bytegrams</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500000</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Larger bytegrams calculated: </span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bytetext</span><span class="p">)</span><span class="si">}</span><span class="s2">, dict: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">bytegrams_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weight_bytegrams</span><span class="p">(</span><span class="n">eg_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;weights compiled&quot;</span><span class="p">)</span>

            <span class="n">rem_err</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">bg</span> <span class="ow">in</span> <span class="n">bytegrams_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="c1"># print(f&quot;Error: {bg} in b2i&quot;)</span>
                    <span class="n">rem_err</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">bytegrams_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rem_err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">rem_err</span><span class="si">}</span><span class="s2"> bytegrams of length 1 from bytegrams_list: they shouldn&#39;t be there. (XXX)&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytegrams_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_tokens</span> <span class="o">-</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="n">bytegrams_list</span> <span class="o">=</span> <span class="n">bytegrams_list</span><span class="p">[:</span> <span class="n">max_tokens</span> <span class="o">-</span> <span class="mi">256</span><span class="p">]</span>

            <span class="c1"># use indices 0-255 to for raw utf-8 bytes that are not in the ngram list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">256</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bytegrams_list</span><span class="p">)}</span>
            <span class="k">del</span> <span class="n">bytegrams_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytegram_tokenizer_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="n">tokenizer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="n">tokenizer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Encoding text corpora&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">500000</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;alias&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoding larger text </span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoding larger text </span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">:</span>
                <span class="n">textbody</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
                <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">textbody</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">chunk_size</span><span class="p">:</span>  <span class="c1"># less verbose</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunking: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">textbody</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">textbody</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">])</span>
                    <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">enc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Encoding text corpora done.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Text_Dataset.save_tokenizer">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.save_tokenizer">[docs]</a>
    <span class="k">def</span> <span class="nf">save_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save tokenizer data and text library to JSON-file.</span>

<span class="sd">        This json file can be loaded with load_tokenizer() and has all information needed</span>
<span class="sd">        to use the tokenizer with trained models and new text.</span>

<span class="sd">        :param file_path: path to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving tokenizer to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;tokenizer_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="p">,</span>
                    <span class="s2">&quot;tokenizer_file_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_file_version</span><span class="p">,</span>
                    <span class="s2">&quot;w2i&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">,</span>
                    <span class="s2">&quot;i2w&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span><span class="p">,</span>
                    <span class="s2">&quot;c2i&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">,</span>
                    <span class="s2">&quot;i2c&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">,</span>
                    <span class="s2">&quot;t2i&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">,</span>
                    <span class="s2">&quot;i2t&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span><span class="p">,</span>
                    <span class="c1"># &quot;b2i&quot;: self.b2i,  can&#39;t serialize tuples, but they are redundant anyway</span>
                    <span class="s2">&quot;i2b&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span><span class="p">,</span>
                    <span class="s2">&quot;word_tokenizer_init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer_init</span><span class="p">,</span>
                    <span class="s2">&quot;char_tokenizer_init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_tokenizer_init</span><span class="p">,</span>
                    <span class="s2">&quot;ngram_tokenizer_init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngram_tokenizer_init</span><span class="p">,</span>
                    <span class="s2">&quot;bytegram_tokenizer_init&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytegram_tokenizer_init</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="s2">&quot;word_separator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span><span class="p">,</span>
                    <span class="s2">&quot;max_ngrams&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span><span class="p">,</span>
                    <span class="s2">&quot;text_list&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">f</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Text_Dataset.load_tokenizer">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.load_tokenizer">[docs]</a>
    <span class="k">def</span> <span class="nf">load_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load tokenizer data and text library from JSON-file.</span>

<span class="sd">        :param file_path: path to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tokenizer from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;tokenizer_file_version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tokenizer_file_version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_file_version</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Can&#39;t load tokenizer data, expecting tokenizer_file_version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_file_version</span><span class="si">}</span><span class="s2">, suitable version tag not found.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown tokenizer version, required version is: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_file_version</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tokenizer_type&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;w2i&quot;</span><span class="p">]</span>
            <span class="n">i2w</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2w&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i2w</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">i2w</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;c2i&quot;</span><span class="p">]</span>
            <span class="n">i2c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2c&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">i2c</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;t2i&quot;</span><span class="p">]</span>
            <span class="n">i2t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2t&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i2t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># self.b2i = data[&quot;b2i&quot;]</span>
            <span class="n">i2b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2b&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i2b</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;i2b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2b</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer_init</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;word_tokenizer_init&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_tokenizer_init</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;char_tokenizer_init&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngram_tokenizer_init</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ngram_tokenizer_init&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytegram_tokenizer_init</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bytegram_tokenizer_init&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;word_separator&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;max_ngrams&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text_list&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading tokenizer done.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Text_Dataset.tokenize">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.tokenize">[docs]</a>
    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize a text.</span>

<span class="sd">        :param text: text to tokenize</span>
<span class="sd">        :return: list of tokens&quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_tokenizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;word&quot;</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_word_splitter</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_tokenizer_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_tokenizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;char&quot;</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngram_tokenizer_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_tokenizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;ngram&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wrd_list</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wrd_list</span><span class="p">:</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">is_special</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
                                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="n">st</span><span class="p">])</span>
                                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">:]</span>
                                <span class="n">is_special</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">is_special</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">mx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">tk</span> <span class="o">=</span> <span class="n">word</span><span class="p">[:</span><span class="n">si</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">:</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span>
                                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">si</span><span class="p">:]</span>
                                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">:</span>
                                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">])</span>  <span class="c1"># unknown encounter</span>
                                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># throw away one char</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;wsep&gt;&quot;</span><span class="p">])</span>  <span class="c1"># word separator</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrd_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove last seperator</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">is_special</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
                            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="n">st</span><span class="p">])</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">:]</span>
                            <span class="n">is_special</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">is_special</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">mx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">tk</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">si</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">si</span><span class="p">:]</span>
                            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">:</span>
                            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">])</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytegram_tokenizer_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Init bytegram&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_tokenizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="s2">&quot;bytegram&quot;</span><span class="p">)</span>
            <span class="n">byte_text</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">is_special</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_words</span><span class="p">:</span>
                    <span class="n">b_st</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">b_st</span> <span class="o">==</span> <span class="n">byte_text</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_st</span><span class="p">)]:</span>  <span class="c1"># text.startswith(st):</span>
                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">[</span><span class="n">b_st</span><span class="p">])</span>
                        <span class="n">byte_text</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">byte_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">b_st</span><span class="p">)</span> <span class="p">:]</span>
                        <span class="n">is_special</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">is_special</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">mx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ngrams</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_text</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">tk</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">byte_text</span><span class="p">[:</span><span class="n">si</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">:</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span>
                        <span class="n">byte_text</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">byte_text</span><span class="p">[</span><span class="n">si</span><span class="p">:]</span>
                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byte_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">:</span>
                        <span class="c1"># st = tuple(bytearray(&quot;&lt;unk&gt;&quot;, &quot;utf-8&quot;))</span>
                        <span class="c1"># tokens.append(self.b2i[st])</span>
                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_text</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">byte_text</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">byte_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span></div>


<div class="viewcode-block" id="Text_Dataset.encode">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.encode">[docs]</a>
    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode a text.</span>

<span class="sd">        :param text: text to encode</span>
<span class="sd">        :return: list of encoded tokens&quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoded</span></div>


<div class="viewcode-block" id="Text_Dataset.decode">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.decode">[docs]</a>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">mark_separator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode a list of encoded tokens.</span>

<span class="sd">        :param encoded: list of encoded tokens</span>
<span class="sd">        :param mark_separator: (ngram only) if True, add a separator between tokens for debug</span>
<span class="sd">        :return: text&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="k">else</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">encoded</span>
            <span class="p">]</span>
            <span class="n">decoded_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">encoded</span>
            <span class="p">]</span>
            <span class="n">decoded_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">encoded</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;wsep&gt;&quot;</span><span class="p">]:</span>  <span class="c1"># Separator</span>
                    <span class="n">dec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span>
                <span class="k">elif</span> <span class="n">ind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]:</span>  <span class="c1"># Unknown token</span>
                    <span class="n">dec</span> <span class="o">+=</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2t</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">mark_separator</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">dec</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
            <span class="n">decoded_text</span> <span class="o">=</span> <span class="n">dec</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">bdec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">encoded</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
                    <span class="n">bdec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">ind</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bdec</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">dec</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bdec</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                        <span class="n">bdec</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">ind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="s2">&quot;&lt;wsep&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))]</span>
                    <span class="p">):</span>  <span class="c1"># Separator</span>
                        <span class="n">dec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_separator</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">ind</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))]</span>
                    <span class="p">):</span>  <span class="c1"># Unknown token</span>
                        <span class="n">dec</span> <span class="o">+=</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dec</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2b</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                            <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">mark_separator</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">dec</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
            <span class="k">if</span> <span class="n">bdec</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">dec</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bdec</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                <span class="n">bdec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">decoded_text</span> <span class="o">=</span> <span class="n">dec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded_text</span></div>


<div class="viewcode-block" id="Text_Dataset.get_unique_token_count">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.get_unique_token_count">[docs]</a>
    <span class="k">def</span> <span class="nf">get_unique_token_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of unique tokens.</span>

<span class="sd">        :return: number of unique tokens&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">256</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Text_Dataset.init_getitem">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.init_getitem">[docs]</a>
    <span class="k">def</span> <span class="nf">init_getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">sample_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">content_stepping</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the __getitem__ and __len__ methods.</span>

<span class="sd">        This method needs to be called before using len() or index-access of the dataset.</span>

<span class="sd">        This method determines how the dataset is partitioned into records, and what kind</span>
<span class="sd">        of encoding is returned on index-access.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from ml_indie_tools.Text_Dataset import TextDataset</span>
<span class="sd">            tl = [{&#39;author&#39;:&#39;nobody&#39;, &#39;title&#39;:&#39;some title&#39;, &#39;language&#39;:&#39;english&#39;, &#39;text&#39;:&#39;some text&#39;},</span>
<span class="sd">                  {&#39;author&#39;:&#39;nobody&#39;, &#39;title&#39;:&#39;some title 2&#39;, &#39;language&#39;:&#39;english&#39;, &#39;text&#39;:&#39;some more text&#39;}]</span>
<span class="sd">            td = Text_Dataset(tl)</span>
<span class="sd">            td.init_getitem(sample_type=&#39;text&#39;, sample_length=4, content_stepping=2)</span>
<span class="sd">            print(len(td))</span>
<span class="sd">            print(td[0])</span>
<span class="sd">            # Output: 12 and (&#39;some&#39;, &#39;ome &#39;)</span>

<span class="sd">        The method of tokenization (char, word, ngram) for &#39;encoded&#39; sample_type is determined by</span>
<span class="sd">        the tokenizer_type in call to init_tokenizer().</span>

<span class="sd">        :param sample_type: &#39;text&#39; (text-string of length sample_length), &#39;encoded&#39; (encoded sample_length tokens)</span>
<span class="sd">        :param sample_length: length of a sample (either character count (type text) or token count (type encoded))</span>
<span class="sd">        :param content_stepping: number of characters/tokens to skip between each sample</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_type</span> <span class="o">=</span> <span class="n">sample_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_length</span> <span class="o">=</span> <span class="n">sample_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_content_stepping</span> <span class="o">=</span> <span class="n">content_stepping</span>
        <span class="n">len_tot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rec_tot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sample_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;encoded&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown sample type </span><span class="si">{</span><span class="n">sample_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getitem_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">sample_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">leni</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">sample_type</span> <span class="o">==</span> <span class="s2">&quot;encoded&quot;</span><span class="p">:</span>
                <span class="n">leni</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown sample type </span><span class="si">{</span><span class="n">sample_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getitem_length</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="p">(</span><span class="n">leni</span> <span class="o">-</span> <span class="n">content_stepping</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">content_stepping</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s2">&quot;records&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span>
            <span class="n">len_tot</span> <span class="o">+=</span> <span class="n">leni</span>
            <span class="n">rec_tot</span> <span class="o">+=</span> <span class="n">recs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_length</span> <span class="o">=</span> <span class="n">len_tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span> <span class="o">=</span> <span class="n">rec_tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getitem_init</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the length of the dataset.</span>

<span class="sd">        Note that this length depends on the initialization via :ref:`~Text_Dataset.Text_Dataset.init_getitem`.</span>

<span class="sd">        :return: length of the dataset (mode dependent)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;init_getitem must be called before __len__&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a sample from the dataset.</span>

<span class="sd">        Format of the returned sample depends on :ref:`~Text_Dataset.Text_Dataset.init_getitem`.</span>

<span class="sd">        :param index: index of the sample</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;init_getitem must be called before __getitem__&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;init_getitem must be called before __getitem__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range&quot;</span><span class="p">)</span>
        <span class="n">cur_rec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;records&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cur_rec</span> <span class="o">+</span> <span class="n">rec</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">rel_rec</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="n">cur_rec</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">rel_rec</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_content_stepping</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_length</span><span class="p">]</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_length</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># pad with  character</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="s2">&quot;&lt;unk&gt;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">sample</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_type</span> <span class="o">==</span> <span class="s2">&quot;encoded&quot;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text_encoded&quot;</span><span class="p">][</span>
                        <span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_length</span>
                    <span class="p">]</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_length</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c2i</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]]</span>  <span class="c1"># pad with  character</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;ngram&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">w2i</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">==</span> <span class="s2">&quot;bytegram&quot;</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">b2i</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tokenizer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">sample</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown sample type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getitem_sample_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">cur_rec</span> <span class="o">+=</span> <span class="n">rec</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Internal error in __getitem__&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error in __getitem__&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Text_Dataset.get_random_item">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.get_random_item">[docs]</a>
    <span class="k">def</span> <span class="nf">get_random_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a random sample from the dataset.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;init_getitem must be called before get_random_item&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;init_getitem must be called before get_random_item&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem_records</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_display_colored_html</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">textlist</span><span class="p">,</span> <span class="n">dark_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_ref_anchor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function to display text and citation references in HTML.&quot;&quot;&quot;</span>
        <span class="n">bgcolorsWht</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#d4e6e1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d8daef&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#ebdef0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#eadbd8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#e2d7d5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#edebd0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#ecf3cf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d4efdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d0ece7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d6eaf8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d4e6f1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#d6dbdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#f6ddcc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#fae5d3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#fdebd0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#e5e8e8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#eaeded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#A9CCE3&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">bgcolorsDrk</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#342621&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#483a2f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3b4e20&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#2a3b48&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#324745&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3d3b30&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3c235f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#443f4f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#403c37&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#463a28&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#443621&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#364b5f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#264d4c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#2a3553&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3d2b40&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#354838&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3a3d4d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#594C23&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">dark_mode</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">bgcolors</span> <span class="o">=</span> <span class="n">bgcolorsWht</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bgcolors</span> <span class="o">=</span> <span class="n">bgcolorsDrk</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">txt</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">textlist</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">txt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">display_ref_anchor</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">anchor</span> <span class="o">=</span> <span class="s2">&quot;&lt;sup&gt;[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&lt;/sup&gt;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anchor</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s1">&#39;&lt;span style=&quot;background-color:&#39;</span>
                    <span class="o">+</span> <span class="n">bgcolors</span><span class="p">[</span><span class="n">ind</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s1">&#39;;&quot;&gt;&#39;</span>
                    <span class="o">+</span> <span class="n">txt</span>
                    <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span>
                    <span class="o">+</span> <span class="n">anchor</span>
                <span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> <span class="n">post</span><span class="p">))</span>

<div class="viewcode-block" id="Text_Dataset.source_highlight">
<a class="viewcode-back" href="../index.html#Text_Dataset.Text_Dataset.source_highlight">[docs]</a>
    <span class="k">def</span> <span class="nf">source_highlight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ref_txt</span><span class="p">,</span> <span class="n">min_quote_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dark_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_ref_anchor</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyse which parts of `ref_txt` are cited from the texts in the Text_Dataset.</span>

<span class="sd">        Note: this function requires a jupyter notebook in order to display HTML with markup.</span>

<span class="sd">        :param ref_txt: the reference text to be analysed for plagiarised parts</span>
<span class="sd">        :param min_quote_size: minimum size of a quote to be considered plagiarised</span>
<span class="sd">        :param dark_mode: if True, the background colors will be dark, otherwise white</span>
<span class="sd">        :param display_ref_anchor: if True, the reference text will be displayed with a reference anchor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_tx</span> <span class="o">=</span> <span class="n">ref_txt</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">qts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">txsrc</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Sources: &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">noquote</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># search all library files for quote &#39;txt&#39;</span>
            <span class="n">mxQ</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mxI</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mxN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_list</span><span class="p">:</span>  <span class="c1"># find longest quote in all texts</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">min_quote_size</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_tx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ref_tx</span><span class="p">[:</span><span class="n">p</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">min_quote_size</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_tx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ref_tx</span><span class="p">[:</span><span class="n">p</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]:</span>
                        <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">mxQ</span><span class="p">:</span>
                        <span class="n">mxQ</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">mxI</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;alias&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                            <span class="n">mxN</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mxN</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">text</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>  <span class="c1"># save longest quote for colorizing</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noquote</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">noquote</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">noquote</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ref_tx</span><span class="p">[:</span><span class="n">mxQ</span><span class="p">],</span> <span class="n">mxI</span><span class="p">))</span>
                <span class="n">ref_tx</span> <span class="o">=</span> <span class="n">ref_tx</span><span class="p">[</span><span class="n">mxQ</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">mxI</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qts</span><span class="p">:</span>  <span class="c1"># create a new reference, if first occurence</span>
                    <span class="n">qts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mxI</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sc</span><span class="p">:</span>
                        <span class="n">txsrc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">txsrc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mxN</span><span class="p">,</span> <span class="n">mxI</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noquote</span> <span class="o">+=</span> <span class="n">ref_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ref_tx</span> <span class="o">=</span> <span class="n">ref_tx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noquote</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">noquote</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">noquote</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_colored_html</span><span class="p">(</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">dark_mode</span><span class="o">=</span><span class="n">dark_mode</span><span class="p">,</span> <span class="n">display_ref_anchor</span><span class="o">=</span><span class="n">display_ref_anchor</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># print references, if there is at least one source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_colored_html</span><span class="p">(</span>
                <span class="n">txsrc</span><span class="p">,</span>
                <span class="n">dark_mode</span><span class="o">=</span><span class="n">dark_mode</span><span class="p">,</span>
                <span class="n">display_ref_anchor</span><span class="o">=</span><span class="n">display_ref_anchor</span><span class="p">,</span>
                <span class="n">pre</span><span class="o">=</span><span class="s1">&#39;&lt;small&gt;&lt;p style=&quot;text-align:right;&quot;&gt;&#39;</span><span class="p">,</span>
                <span class="n">post</span><span class="o">=</span><span class="s2">&quot;&lt;/p&gt;&lt;/small&gt;&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ml-indie-tools 0.11.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Text_Dataset</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022-2024, dsc.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>